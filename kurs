from datetime import datetime

from telethon import events
from telethon.tl.functions.users import GetFullUserRequest

from .. import loader, utils


@loader.tds
class IDModule(loader.Module):
    """Получает ID и дату создания аккаунта пользователя Telegram"""

    strings = {"name": "ID"}

    async def client_ready(self, client, db):
        self.client = client

    @loader.unrestricted
    async def idcmd(self, message):
        """Используй: .id @username/реплай на сообщение"""
        
        user = None
        
        args = utils.get_args_raw(message)
        reply = await message.get_reply_message()

        if args:
            try:
                user = await self.client.get_entity(args)
            except ValueError:
                await utils.answer(message, "<b>Не удалось найти пользователя.</b>")
                return

        elif reply:
            user = reply.sender

        if not user:
            return
            
        full_user = await self.client(GetFullUserRequest(user.id))
        created = datetime.fromtimestamp(full_user.user.date).strftime("%d.%m.%Y %H:%M")
        
        await utils.answer(message, 
            f"<b>ID пользователя {user.first_name}: <code>{user.id}</code>\n"
            f"Аккаунт был создан: {created}</b>"
        )
